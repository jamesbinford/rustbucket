# Instance Registration Design

## 1. Overview

Rustbucket includes an optional feature to allow individual honeypot instances to register themselves with a central registry server. This can be useful for tracking deployed instances, gathering basic metadata, or coordinating distributed honeypots.

**Instance registration is completely optional.** If no Rustbucket URL is configured in either an environment variable or in `Config.toml`, rustbucket simply won't attempt to register the instance and will continue normal operation.

The registration is performed by the `registration.rs` module. The main public function is `register_instance()`, which is an asynchronous function. This function is called automatically during startup from `src/main.rs` before the port listeners begin accepting connections.

## 2. Configuration

The registration process is configured primarily via environment variables, with fallback support for the `Config.toml` file.

### Environment Variable Configuration:
The registry URL is primarily configured through the `RUSTBUCKET_REGISTRY_URL` environment variable:

```bash
export RUSTBUCKET_REGISTRY_URL="http://your-registry.example.com/api/v1/register_bucket/"
```

### `Config.toml` Fallback Structure:
If the environment variable is not set, the system will check `Config.toml`:
```toml
[registration]
# Fallback URL of the central registry server (only used if RUSTBUCKET_REGISTRY_URL env var is not set)
rustbucket_registry_url = "http://your-registry.example.com/api/v1/register_bucket/"

# Health check configuration
health_check_interval = 300  # seconds (default: 5 minutes)
health_check_enabled = true  # default: true if registration is configured
```

-   **`RUSTBUCKET_REGISTRY_URL`**: (Environment Variable) The full URL of the endpoint on the central registry server that handles new instance registrations. **This is the preferred configuration method.**
-   **`rustbucket_registry_url`**: (Optional Config String) Fallback URL used only if the environment variable is not set.

### Configuration Loading Priority:
The `register_instance()` function in `src/registration.rs` loads configuration in this order:
1. Check for `RUSTBUCKET_REGISTRY_URL` environment variable
2. If not found, attempt to load from `Config.toml` → `[registration]` → `rustbucket_registry_url`
3. If neither is found, registration is skipped entirely (no default URL)

## 3. Registration Process

When `register_instance()` is called, it performs the following steps:

### 3.1. Generate Instance Identity
Two pieces of information are generated locally to identify the instance:

-   **Name**: A unique name for the honeypot instance.
    -   Format: `rustbucket-` followed by an 8-character alphanumeric random suffix (e.g., `rustbucket-aBcDeFgH`).
    -   Generated by `generate_name()` function using the `rand` crate.
-   **Token**: A secret token for the instance, potentially for future authentication with the registry.
    -   Format: A 32-character alphanumeric random string.
    -   Generated by `generate_token()` function using the `rand` crate.
    -   *Note: Currently, the token is logged for debugging purposes. This should be reviewed for production deployments.*

### 3.2. Prepare Payload
A JSON payload is constructed with the generated name and token.

**Payload Structure:**
```json
{
    "name": "<generated_name>",
    "token": "<generated_token>"
}
```
This is represented by the `RegistrationPayload` struct in `src/registration.rs`.

### 3.3. HTTP POST Request
An HTTP POST request is made to the configured `rustbucket_registry_url` (or the default if not configured).
-   The `Content-Type` of the request is `application/json`.
-   The body of the request is the JSON payload described above.
-   The request is made using the `reqwest` crate.

### 3.4. Handle Response
The system logs the outcome of the registration attempt based on the HTTP response from the registry server:

-   **Success (HTTP 200 OK)**: Logs a success message including the instance name and the server's response body.
-   **Failure (HTTP 404 Not Found)**: Logs an error indicating a bad URL.
-   **Failure (HTTP 500 Internal Server Error)**: Logs an error indicating a server-side issue at the registry.
-   **Other Statuses**: Logs a warning with the unexpected status code and response body.
-   **Request Error**: If the HTTP request itself fails (e.g., network issue, DNS failure), an error is logged detailing the failure.

## 4. Error Handling

The `registration.rs` module handles errors at several 
stages:

-   **Configuration Loading**: If `Config.toml` cannot be read or the `rustbucket_registry_url` is missing, a warning is logged, and the process continues with a default URL. Critical parsing errors might cause `register_instance` to use the default URL immediately.
-   **HTTP Request Failure**: Errors during the `reqwest::Client::post().send()` call (e.g., network errors) are caught and logged. The registration attempt is aborted for that cycle.
-   **Non-Successful HTTP Responses**: Specific HTTP error codes (404, 500) and other non-200 statuses are logged with details from the response.

The `register_instance()` function itself does not return a `Result` and is designed to complete without panicking the main application, logging its outcomes internally.

## 5. Security Considerations

-   **Token Security**: The generated token is currently logged. In a production environment, logging sensitive tokens should be avoided. The purpose and handling of this token by the registry server would also dictate security measures.
-   **Registry Endpoint Security**: The registry server endpoint (`rustbucket_registry_url`) should be secured (e.g., using HTTPS, authentication/authorization if necessary) to prevent unauthorized registrations or information leakage, though the current client implementation in `registration.rs` uses HTTP by default if the scheme is not specified in the URL.
-   **Data Exposure**: The instance name and token are sent to the registry. Consideration should be given to what information the registry stores and how it's protected.
-   **Default URL**: The fallback to `http://localhost:8080/register` might have security implications if a malicious service is running on that port on the honeypot host or a reachable network segment.

## 6. Health Check Strategy

To maintain registry awareness of active instances, Rustbucket implements a periodic health check mechanism.

### 6.1. Health Check Configuration

Health checks are configured in the `[registration]` section of `Config.toml`:

```toml
[registration]
rustbucket_registry_url = "http://your-registry.example.com/api/v1/register_bucket/"
health_check_interval = 300  # seconds (default: 5 minutes)
health_check_enabled = true  # default: true if registration is configured
```

-   **`health_check_interval`**: (Optional u64) Time in seconds between health check requests. Defaults to 300 seconds (5 minutes).
-   **`health_check_enabled`**: (Optional bool) Whether to send periodic health checks. Defaults to `true` if registration is configured.

### 6.2. Health Check Process

After successful initial registration, a background task is spawned to send periodic health checks:

1. **Background Task**: Uses `tokio::spawn()` to create a non-blocking background task that runs for the lifetime of the application.

2. **Health Check Payload**: Sends a minimal JSON payload to the registry's health check endpoint:
   ```json
   {
       "name": "<instance_name>",
       "token": "<instance_token>",
       "uptime": 12345,
       "active_connections": 42,
       "status": "healthy"
   }
   ```

3. **Health Check Endpoint**: Uses the same base URL as registration but replaces `/register_bucket/` with `/health`:
   - Registration: `http://registry.example.com/api/v1/register_bucket/`
   - Health Check: `http://registry.example.com/api/v1/health`

4. **Timing**: Uses `tokio::time::sleep()` with the configured interval between checks.

### 6.3. Health Check Error Handling

-   **Network Failures**: Logged as warnings, health checks continue with exponential backoff (max 30 minutes).
-   **HTTP Errors**: 
     - 404: Instance not found in registry, attempts re-registration once
     - 401/403: Authentication failure, logs error and disables further health checks
     - 500: Server error, continues with backoff
-   **Registry Unavailable**: After 3 consecutive failures, health check frequency reduces to once per hour until recovery.

### 6.4. Graceful Shutdown

On application shutdown, a final health check is sent with `"status": "shutting_down"` to notify the registry of planned downtime.

## 7. Future Enhancements

-   **Registry Authentication**: The client could use the generated token or other credentials to authenticate with the registry.
-   **Retry Logic**: Implement retry mechanisms with backoff for transient network errors or server unavailability.
-   **More Detailed Payload**: Include more instance details in the registration payload (e.g., version, uptime, active ports).
-   **Dynamic Configuration**: Allow enabling/disabling registration via `Config.toml`.
-   **Integration into Main Flow**: Provide a clear mechanism or configuration to automatically call `register_instance()` on startup if desired.
-   **Secure Token Handling**: Remove token logging in production and ensure secure transmission (HTTPS).
-   **Registry Discovery**: Implement a discovery mechanism if the registry URL is not static.
-   **Deregistration**: A way for instances to de-register.
-   **Health Check Metrics**: Include additional metrics in health checks (memory usage, disk space, attack statistics).
```
